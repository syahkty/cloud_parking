<!doctype html>
<html lang="id">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Palang Cloud Control (Event-Driven)</title>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<style>
  :root{--bg:#0b1020;--card:#121a33;--mut:#273458;--txt:#e8f0ff;--ok:#2b8a3e}
  body{margin:0;background:var(--bg);color:var(--txt);font-family:system-ui,Segoe UI,Arial,sans-serif}
  .wrap{max-width:760px;margin:40px auto;padding:20px}
  .card{background:var(--card);border:1px solid var(--mut);border-radius:16px;padding:18px}
  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  input{background:#0f1730;border:1px solid var(--mut);color:var(--txt);border-radius:10px;padding:10px;min-width:260px}
  .btn{border:0;border-radius:12px;padding:12px 16px;font-weight:700;cursor:pointer}
  .btn-green{background:var(--ok);color:#fff}
  .tag{display:inline-block;padding:6px 10px;border:1px solid var(--mut);border-radius:999px;background:#0f1730}
  .led{display:inline-block;width:12px;height:12px;border-radius:50%;margin-right:6px;vertical-align:middle}
  .r{background:#ff4d4f}.y{background:#ffd23f}.g{background:#41d37e}.n{background:#4a5568}
  pre{background:#0f1730;border:1px solid var(--mut);padding:10px;border-radius:10px;white-space:pre-wrap}
  small{opacity:.7}
</style>
</head>
<body>
<div class="wrap">
  <h2>Palang Cloud Control</h2>
  <div class="card">
    <div class="row">
      <input id="api" placeholder="API base" value="https://d2shze8jl6.execute-api.ap-southeast-1.amazonaws.com">
      <input id="dev" placeholder="Device ID" value="PALANG-01">
      <input id="key" placeholder="API key (opsional)">
      <button id="btnOpen" class="btn btn-green">OPEN (Buka Palang)</button>
      <button id="btnRefresh" class="btn">Refresh</button>
    </div>

    <div class="row" style="margin-top:12px">
      <div class="tag"><span id="led" class="led n"></span><b id="ledText">Unknown</b></div>
      <div class="tag"><b>Gate:</b> <span id="gate">Unknown</span></div>
      <div class="tag"><b>Last Cmd:</b> <span id="updated">—</span></div>
    </div>

    <div style="margin-top:12px">
      <b>Command (/command)</b>
      <pre id="cmdBox">{}</pre>
      <small>Catatan: ESP32 <i>tidak</i> mengirim telemetry reguler. Ia hanya mengirim saat objek terdeteksi (MERAH). Menekan OPEN di sini akan tersimpan di cloud; ESP32 akan mengambilnya hanya ketika ada deteksi (atau dalam jendela beberapa detik setelahnya).</small>
    </div>
  </div>
</div>

<script>
const $  = id => document.getElementById(id);
const api= () => $('api').value.replace(/\/$/,'');
const dev= () => $('dev').value.trim();
const key= () => $('key').value.trim();

function headers(json=false){
  const h = json ? {'Content-Type':'application/json'} : {};
  if (key()) h['x-api-key'] = key();
  return h;
}
async function postJSON(url, obj){
  const r = await fetch(url, {method:'POST', headers:headers(true), body:JSON.stringify(obj)});
  const j = await r.json().catch(()=>({}));
  if (!r.ok) throw new Error(JSON.stringify(j));
  return j;
}
async function getJSON(url){
  const r = await fetch(url, {headers:headers(false)});
  const j = await r.json().catch(()=>({}));
  if (!r.ok) throw new Error(JSON.stringify(j));
  return j;
}

function paintUI(cmd){
  $('cmdBox').textContent = JSON.stringify(cmd, null, 2);
  const isOpen = !!cmd.open;
  $('led').className = 'led ' + (isOpen?'g':'r');
  $('ledText').textContent = isOpen ? 'OPEN requested' : 'CLOSED requested';
  $('gate').textContent = isOpen ? 'Menunggu ESP buka' : 'Menunggu ESP tutup';
  $('updated').textContent = cmd.updatedAt ? new Date(cmd.updatedAt).toLocaleString() : '—';
}

async function refresh(){
  try{
    const cmd = await getJSON(`${api()}/command?deviceId=${encodeURIComponent(dev())}&_=${Date.now()}`);
    paintUI(cmd);
  }catch(e){
    $('cmdBox').textContent = 'ERR ' + e.message;
    $('led').className='led n';
    $('ledText').textContent='Unknown';
    $('gate').textContent='Unknown';
    $('updated').textContent='—';
  }
}

$('btnOpen').onclick = async ()=>{
  $('btnOpen').disabled = true;
  try{
    await postJSON(`${api()}/set-command`, { deviceId: dev(), open: true });
    Swal.fire({icon:'success', title:'OPEN dikirim', text:'Perintah OPEN tersimpan di cloud. ESP akan mengambil saat deteksi.'});
    await refresh();
  }catch(e){
    Swal.fire({icon:'error', title:'Gagal kirim OPEN', text:e.message});
  }finally{
    $('btnOpen').disabled = false;
  }
};
$('btnRefresh').onclick = refresh;

refresh();
</script>
</body>
</html>
