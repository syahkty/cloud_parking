<!doctype html>
<html lang="id">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Palang Cloud Control</title>
<style>
  :root{--bg:#0b1020;--card:#121a33;--mut:#273458;--txt:#e8f0ff;--ok:#2b8a3e}
  body{margin:0;background:var(--bg);color:var(--txt);font-family:system-ui,Segoe UI,Arial,sans-serif}
  .wrap{max-width:760px;margin:40px auto;padding:20px}
  .card{background:var(--card);border:1px solid var(--mut);border-radius:16px;padding:18px}
  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  input{background:#0f1730;border:1px solid var(--mut);color:var(--txt);border-radius:10px;padding:10px;min-width:260px}
  .btn{border:0;border-radius:12px;padding:12px 16px;font-weight:700;cursor:pointer}
  .btn-green{background:var(--ok);color:#fff}
  pre{background:#0f1730;border:1px solid var(--mut);padding:10px;border-radius:10px;white-space:pre-wrap}
  small{opacity:.7}
</style>
</head>
<body>
<div class="wrap">
  <h2>Palang Cloud Control</h2>
  <div class="card">
    <div class="row">
      <input id="api" placeholder="API base" value="https://d2shze8jl6.execute-api.ap-southeast-1.amazonaws.com">
      <input id="dev" placeholder="Device ID" value="PALANG-01">
      <input id="key" placeholder="API key (opsional)">
      <button id="btnOpen" class="btn btn-green">OPEN (Buka Palang)</button>
      <button id="btnRefresh" class="btn">Refresh</button>
    </div>

    <div class="row" style="margin-top:12px">
      <div>
        <b>Command (/command)</b>
        <pre id="cmdBox">{}</pre>
      </div>
      <div>
        <b>State (/state)</b> <small>(opsional, jika Lambda menyimpan STATE)</small>
        <pre id="stateBox">{}</pre>
      </div>
    </div>
  </div>
</div>

<script>
const $ = id => document.getElementById(id);
const api = () => $('api').value.replace(/\/$/,'');
const dev = () => $('dev').value.trim();
const key = () => $('key').value.trim();

async function postJSON(url, obj){
  const headers = {'Content-Type':'application/json'};
  if (key()) headers['x-api-key'] = key();
  const r = await fetch(url, {method:'POST', headers, body:JSON.stringify(obj)});
  const j = await r.json().catch(()=>({}));
  if(!r.ok) throw new Error(JSON.stringify(j));
  return j;
}
async function getJSON(url){
  const headers = {};
  if (key()) headers['x-api-key'] = key();
  const r = await fetch(url, {headers});
  const j = await r.json().catch(()=>({}));
  if(!r.ok) throw new Error(JSON.stringify(j));
  return j;
}

// === ACTION: klik OPEN -> POST /set-command {deviceId, open:true}
$('btnOpen').onclick = async ()=>{
  $('btnOpen').disabled = true;
  try{
    const j = await postJSON(`${api()}/set-command`, { deviceId: dev(), open: true });
    alert('Perintah OPEN terkirim.');
    await refreshAll();      // tampilkan command/state terbaru
  }catch(e){
    alert('Gagal kirim OPEN: ' + e.message);
  }finally{
    $('btnOpen').disabled = false;
  }
};

$('btnRefresh').onclick = refreshAll;

async function refreshAll(){
  try{
    const cmd = await getJSON(`${api()}/command?deviceId=${encodeURIComponent(dev())}&_=${Date.now()}`);
    $('cmdBox').textContent = JSON.stringify(cmd, null, 2);
  }catch(e){ $('cmdBox').textContent = 'ERR ' + e.message; }
  try{
    const st  = await getJSON(`${api()}/state?deviceId=${encodeURIComponent(dev())}&_=${Date.now()}`);
    $('stateBox').textContent = JSON.stringify(st, null, 2);
  }catch(e){ $('stateBox').textContent = '(state tidak tersedia atau error)'; }
}
refreshAll();
</script>
</body>
</html>
